# SMC App - Production Build Guide

## Overview

à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸à¸²à¸£ build SMC Application à¸ªà¸³à¸«à¸£à¸±à¸š production deployment à¸žà¸£à¹‰à¸­à¸¡à¸£à¸°à¸šà¸š license validation à¹à¸¥à¸°à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥

## ðŸš€ Quick Start

```bash
# Build à¸ªà¸³à¸«à¸£à¸±à¸š DS12 (12-slot cabinet)
npm run build:production:ds12

# Build à¸ªà¸³à¸«à¸£à¸±à¸š DS16 (16-slot cabinet) 
npm run build:production:ds16

# à¹€à¸•à¸£à¸µà¸¢à¸¡à¸à¸²à¸£ build à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹„à¸¡à¹ˆ build Electron app)
npm run build-prep:ds12
```

## ðŸ“‹ Prerequisites

### System Requirements
- **Node.js**: v16.0.0 à¸«à¸£à¸·à¸­à¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸²
- **npm**: v8.0.0 à¸«à¸£à¸·à¸­à¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸²
- **Platform**: Windows, macOS, à¸«à¸£à¸·à¸­ Linux

### Environment Variables
à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ `.env` à¹ƒà¸™ root directory:

```env
# Required for production build
SHARED_SECRET_KEY=SMC_LICENSE_ENCRYPTION_KEY_2024_SECURE_MEDICAL_DEVICE_BINDING_32CHARS
ORGANIZATION_NAME=SMC Medical Center
DEVICE_TYPE=DS12

# Optional development settings
NODE_ENV=production
BYPASS_LICENSE=false
```

### License File Requirements
- **File**: `license.lic` (generated by SMC License CLI)
- **Location**: `resources/license.lic` (à¹ƒà¸™ project root)
- **Format**: AES-256-CBC encrypted JSON
- **Content**: Organization, Customer ID, MAC address, Expiry date

## ðŸ”§ Build Process

### Step 1: Prepare Build Environment

```bash
# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸žà¸£à¹‰à¸­à¸¡à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š
npm run validate:build-ready

# à¹€à¸•à¸£à¸µà¸¢à¸¡ build environment
npm run build-prep:ds12  # à¸«à¸£à¸·à¸­ ds16
```

Build preparation script à¸ˆà¸°à¸—à¸³:
1. **Database Reset**: à¸¥à¹‰à¸²à¸‡à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆ
2. **Organization Setup**: à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸‡à¸„à¹Œà¸à¸£
3. **Resources Directory**: à¹€à¸•à¸£à¸µà¸¢à¸¡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸ªà¸³à¸«à¸£à¸±à¸š license
4. **Environment Validation**: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š dependencies à¹à¸¥à¸° configuration

### Step 2: Build Electron Application

```bash
# Complete production build (à¸£à¸§à¸¡ build-prep)
npm run build:production:ds12

# à¸«à¸£à¸·à¸­ build à¹à¸¢à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™
npm run build-prep:ds12
npm run build:ds12
```

### Step 3: License Integration

```bash
# Generate license using CLI tool
cd ../cli
smc-license generate -o "SMC Medical Center" -c "CUSTOMER001" -a "SMC_Cabinet" -e "2025-12-31" --wifi-ssid "SMC_WiFi" --wifi-password "SecurePass123!"

# Copy license to resources directory
cp license.lic ../resources/license.lic

# Validate license system
cd ..
npm run validate:license-system
```

## ðŸ“ Build Output

### Directory Structure
```
dist/
â”œâ”€â”€ win-unpacked/           # Windows build
â”‚   â”œâ”€â”€ SMC.exe             # Main executable
â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â”œâ”€â”€ app.asar        # Application code
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â””â”€â”€ database.db # SQLite database
â”‚   â”‚   â””â”€â”€ license.lic     # License file (copy manually)
â”‚   â””â”€â”€ ...
â”œâ”€â”€ SMC Setup 1.0.0.exe     # Windows installer
â””â”€â”€ ...
```

### macOS Build
```
dist/
â”œâ”€â”€ mac/
â”‚   â””â”€â”€ SMC.app/
â”‚       â””â”€â”€ Contents/
â”‚           â”œâ”€â”€ MacOS/SMC
â”‚           â””â”€â”€ Resources/
â”‚               â”œâ”€â”€ app.asar
â”‚               â”œâ”€â”€ db/database.db
â”‚               â””â”€â”€ license.lic
â””â”€â”€ SMC-1.0.0.dmg           # macOS installer
```

## ðŸ”’ License Deployment

### Production License Workflow

1. **Generate License** (Developer):
   ```bash
   smc-license generate -o "Hospital ABC" -c "HOSP001" -a "SMC_Pro" -e "2025-12-31" --wifi-ssid "HOSP_ESP32" --wifi-password "HospitalSecure123"
   ```

2. **Copy License** (Build Process):
   ```bash
   cp license.lic resources/license.lic
   ```

3. **Build Application**:
   ```bash
   npm run build:production:ds12
   ```

4. **Deploy** (Delivery):
   - Copy `license.lic` à¹„à¸›à¸”à¹‰à¸§à¸¢à¸à¸±à¸š application
   - à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ application à¸šà¸™ customer site
   - License à¸ˆà¸°à¸–à¸¹à¸ validate à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸•à¸­à¸™ startup

### License File Locations (Priority Order)
1. `resources/license.lic` (Production)
2. `dist/resources/license.lic` (Build output)
3. `./license.lic` (Current directory)
4. Environment variable: `SMC_LICENSE_FILE_PATH`

## ðŸ›  Development vs Production

### Development Mode
```bash
# Development build with license bypass
NODE_ENV=development BYPASS_LICENSE=true npm run dev:ds12

# Development build with license validation
NODE_ENV=development npm run dev:ds12
```

### Production Mode
```bash
# Production build (license required)
NODE_ENV=production npm run build:production:ds12
```

## ðŸ§ª Testing & Validation

### Build Validation
```bash
# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š build configuration
npm run config:validate

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š license system
npm run validate:license-system

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸žà¸£à¹‰à¸­à¸¡à¸‚à¸­à¸‡ build
npm run validate:build-ready
```

### License Testing
```bash
# à¸—à¸”à¸ªà¸­à¸š license validation
cd cli
smc-license validate -f ../resources/license.lic

# à¸—à¸”à¸ªà¸­à¸š ESP32 connection
smc-license test-esp32 --ip 192.168.4.1
```

### End-to-End Testing
```bash
# à¸£à¸±à¸™ integration tests
npm run test:integration

# à¸—à¸”à¸ªà¸­à¸š dispensing workflow
npm run test:dispensing-workflow

# à¸—à¸”à¸ªà¸­à¸š hardware connection
npm run test:hardware
```

## ðŸš¨ Troubleshooting

### Common Build Issues

**1. Database Creation Failed**
```bash
# Solution: Check permissions and dependencies
sudo npm install sqlite3 --build-from-source
npm run build-prep:ds12
```

**2. License File Not Found**
```bash
# Solution: Verify license file location
ls -la resources/license.lic
export SMC_LICENSE_FILE_PATH=/path/to/license.lic
```

**3. TypeScript Compilation Errors**
```bash
# Solution: Clean and rebuild
npm run clean
npm install
npm run build:production:ds12
```

**4. Electron Build Failed**
```bash
# Solution: Check Node.js version and rebuild native modules
node --version  # Should be >= 16.0.0
npm run postinstall
npm run build:ds12
```

### License Validation Issues

**1. MAC Address Mismatch**
```
Error: MAC address mismatch between license and ESP32
Solution: 
- Generate new license with correct MAC address
- Check ESP32 connection: smc-license test-esp32
```

**2. License Expired**
```
Error: License expired on 2024-12-31
Solution:
- Generate new license with future expiry date
- Use --no-expiry for permanent licenses (if allowed)
```

**3. Database Not Activated**
```
Error: System not activated - no license found in database
Solution:
- Run license activation: Use SMC app activation dialog
- Check database: npm run validate:build-ready
```

## ðŸ“¦ Distribution

### Windows Distribution
1. `SMC Setup 1.0.0.exe` - Installer
2. `win-unpacked/` - Portable version
3. Include `license.lic` in same directory

### macOS Distribution  
1. `SMC-1.0.0.dmg` - Disk image
2. `SMC.app` - Application bundle
3. License embedded in app bundle

### Linux Distribution
1. `SMC-1.0.0.AppImage` - Portable app
2. Include `license.lic` in same directory

## ðŸ”§ Advanced Configuration

### Custom Build Scripts
```json
{
  "scripts": {
    "build:custom": "cross-env ORGANIZATION_NAME=\"Custom Hospital\" DEVICE_TYPE=DS16 npm run build:production:ds16",
    "build:multi": "npm run build:production:ds12 && npm run build:production:ds16"
  }
}
```

### Environment-Specific Builds
```bash
# Staging build
NODE_ENV=staging npm run build:production:ds12

# Demo build (with license bypass)
BYPASS_LICENSE=true npm run build:production:ds12
```

## ðŸ“ž Support

### Build Issues
1. Check system requirements
2. Verify environment variables
3. Validate license file
4. Run diagnostic commands

### License Issues  
1. Use SMC License CLI diagnostics
2. Test ESP32 connectivity
3. Check license expiry date
4. Verify MAC address binding

For additional support, refer to:
- `cli/README.md` - License CLI documentation
- `docs/system-architecture/` - Technical documentation  
- GitHub Issues - Bug reports and feature requests