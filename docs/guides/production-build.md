# SMC App - Production Build Guide - HKDF v2.0

## Overview

Production build guide for SMC Application with HKDF v2.0 license system. This guide covers building production-ready applications with enhanced security and self-contained license management.

**HKDF v2.0 Benefits:**
- ✅ Enhanced Security: No shared key management required
- ✅ Per-License Encryption: Each customer has unique security
- ✅ Self-Contained: License files include all necessary key derivation data
- ✅ Hardware Binding: ESP32 MAC address validation built-in

## 🚀 Quick Start

```bash
# Build for DS12 (12-slot cabinet) with license
npm run build-prep --license=./cli/customer-license.lic
npm run build:ds12

# Build for DS16 (16-slot cabinet) with license
npm run build-prep --license=./cli/customer-license.lic  
npm run build:ds16

# Complete production workflow (preparation + build)
npm run build:production:ds12 --license=./cli/customer-license.lic
```

## 📋 Prerequisites

### System Requirements
- **Node.js**: v18.0.0 or higher (recommended)
- **npm**: v8.0.0 or higher
- **Platform**: Windows (primary), macOS, Linux

### License File Requirements (HKDF v2.0)
- **File**: `customer-license.lic` (generated by SMC License CLI v2.0)
- **Format**: HKDF v2.0 format with kdf_context
- **Location**: Provided to build-prep script (not embedded in build)
- **Content**: Encrypted customer data with hardware binding

**No Environment Variables Required:**
- ❌ No SHARED_SECRET_KEY needed (deprecated)
- ❌ No manual key management required
- ✅ All encryption keys derived automatically from license data

## 🔧 Build Process - HKDF v2.0

### Step 1: Generate Customer License (CLI)

**Prerequisites:**
```bash
# Navigate to CLI tool
cd cli/

# Ensure CLI is built and ready
npm install
npm run build

# Verify CLI working
smc-license --version
```

**Generate License:**
```bash
# Method 1: Individual license generation
smc-license generate \
  --org "SMC Medical Center Bangkok" \
  --customer "BGK001" \
  --app "SMC_Cabinet" \
  --expiry "2025-12-31" \
  --wifi-ssid "SMC_ESP32_BGK001" \
  --wifi-password "SecurePass123!" \
  --output "BGK001-license.lic"

# Method 2: Batch processing from ESP32 deployment CSV
smc-license batch \
  --input ../esp32-deployment-tool/exports/esp32-deployments-2025-08-25.csv \
  --update-csv

# Validate license created
smc-license validate --file BGK001-license.lic
smc-license info --file BGK001-license.lic
```

### Step 2: Build Preparation (License Integration)

```bash
# Return to project root
cd ../

# Build preparation with license integration (HKDF v2.0)
npm run build-prep --license=./cli/BGK001-license.lic
```

**What build-prep does (HKDF v2.0):**
1. **License Parsing**: Extracts customer data using HKDF key derivation
2. **Database Reset**: Creates clean SQLite database with customer data
3. **Organization Setup**: Populates database with license organization info
4. **License Cleanup**: Removes license file from build for security
5. **Resources Preparation**: Sets up production directory structure

**No Shared Key Required:**
- ✅ HKDF automatically derives keys from license data
- ✅ No environment variables needed
- ✅ Self-contained security system

### Step 3: Build Electron Application

```bash
# Build production application
npm run build:ds12  # for 12-slot cabinet
# OR
npm run build:ds16  # for 16-slot cabinet

# Verify build completed successfully
ls dist/
# Should show: SMC Setup 1.0.0.exe (Windows)
```

**Alternative: Combined Workflow**
```bash
# Single command for complete build process
npm run build:production:ds12 --license=./cli/BGK001-license.lic

# This automatically:
# 1. Runs build-prep with license
# 2. Builds Electron application  
# 3. Packages for deployment
```

## 📁 Build Output

### Directory Structure
```
dist/
├── win-unpacked/           # Windows build
│   ├── SMC.exe             # Main executable
│   ├── resources/
│   │   ├── app.asar        # Application code
│   │   ├── db/
│   │   │   └── database.db # SQLite database
│   │   └── license.lic     # License file (copy manually)
│   └── ...
├── SMC Setup 1.0.0.exe     # Windows installer
└── ...
```

### macOS Build
```
dist/
├── mac/
│   └── SMC.app/
│       └── Contents/
│           ├── MacOS/SMC
│           └── Resources/
│               ├── app.asar
│               ├── db/database.db
│               └── license.lic
└── SMC-1.0.0.dmg           # macOS installer
```

## 🔒 HKDF v2.0 License Deployment

### Production License Workflow (Enhanced Security)

1. **Generate License** (HKDF v2.0):
   ```bash
   # Using HKDF system - no shared key needed
   smc-license generate \
     --org "Hospital ABC" \
     --customer "HOSP001" \
     --app "SMC_Pro" \
     --expiry "2025-12-31" \
     --wifi-ssid "SMC_ESP32_HOSP001" \
     --wifi-password "HospitalSecure123!"
   ```

2. **Build Integration** (Secure):
   ```bash
   # License data extracted and embedded in database
   npm run build-prep --license=HOSP001-license.lic
   
   # License file automatically removed from build for security
   # Customer data now in database, no license file in app
   ```

3. **Build Application**:
   ```bash
   npm run build:ds12
   ```

4. **Deploy Package** (Delivery):
   - `SMC Setup 1.0.0.exe` - Contains database with customer data
   - `HOSP001-license.lic` - Separate license file for customer
   - Customer copies license to `resources/license.lic` after installation

### License File Locations (Priority Order)
1. `resources/license.lic` (Production)
2. `dist/resources/license.lic` (Build output)
3. `./license.lic` (Current directory)
4. Environment variable: `SMC_LICENSE_FILE_PATH`

## 🛠 Development vs Production

### Development Mode
```bash
# Development build with license bypass
NODE_ENV=development BYPASS_LICENSE=true npm run dev:ds12

# Development build with license validation
NODE_ENV=development npm run dev:ds12
```

### Production Mode
```bash
# Production build (license required)
NODE_ENV=production npm run build:production:ds12
```

## 🧪 Testing & Validation

### Build Validation
```bash
# ตรวจสอบ build configuration
npm run config:validate

# ตรวจสอบ license system
npm run validate:license-system

# ตรวจสอบความพร้อมของ build
npm run validate:build-ready
```

### License Testing (HKDF v2.0)
```bash
# Test license validation (HKDF format)
cd cli
smc-license validate --file customer-license.lic

# Show license information (no decryption needed)
smc-license info --file customer-license.lic

# Test ESP32 connection
smc-license test-esp32 --ip 192.168.1.100

# Test HKDF key derivation
smc-license show-key --file customer-license.lic
```

### End-to-End Testing
```bash
# รัน integration tests
npm run test:integration

# ทดสอบ dispensing workflow
npm run test:dispensing-workflow

# ทดสอบ hardware connection
npm run test:hardware
```

## 🚨 Troubleshooting

### Common Build Issues

**1. Database Creation Failed**
```bash
# Solution: Check permissions and dependencies
sudo npm install sqlite3 --build-from-source
npm run build-prep:ds12
```

**2. License File Not Found**
```bash
# Solution: Verify license file location (HKDF v2.0)
ls -la resources/license.lic

# Check if build-prep was run with license
sqlite3 resources/db/database.db "SELECT organization FROM Settings LIMIT 1;"

# Set custom license path if needed
export SMC_LICENSE_FILE_PATH=/path/to/license.lic
```

**3. TypeScript Compilation Errors**
```bash
# Solution: Clean and rebuild
npm run clean
npm install
npm run build:production:ds12
```

**4. Electron Build Failed**
```bash
# Solution: Check Node.js version and rebuild native modules
node --version  # Should be >= 16.0.0
npm run postinstall
npm run build:ds12
```

### HKDF v2.0 License Issues

**1. MAC Address Mismatch (Enhanced Security)**
```
Error: Hardware binding validation failed
Solution: 
- Get current ESP32 MAC: curl http://[ESP32-IP]/mac
- Generate new license with correct MAC address
- HKDF v2.0: MAC never exposed in license file (secure)
```

**2. License Expired**
```
Error: License expired on 2024-12-31
Solution:
- Update expiry: smc-license update-expiry --file license.lic --new-expiry "2026-12-31"
- Generate permanent: smc-license generate --no-expiry [other-options]
```

**3. HKDF Key Derivation Failed**
```
Error: Unable to decrypt license data
Solution:
- Verify license format: smc-license info --file license.lic
- Check ESP32 connectivity for MAC address
- Ensure WiFi SSID matches ESP32 configuration
- Re-run build-prep: npm run build-prep --license=license.lic
```

**4. Database Not Activated (HKDF)**
```
Error: System not activated - license validation failed
Solution:
- Check build-prep was run: sqlite3 database.db "SELECT organization FROM Settings;"
- Verify license at runtime location: ls resources/license.lic
- Restart SMC App to retry license validation
```

## 📦 Distribution

### Windows Distribution
1. `SMC Setup 1.0.0.exe` - Installer
2. `win-unpacked/` - Portable version
3. Include `license.lic` in same directory

### macOS Distribution  
1. `SMC-1.0.0.dmg` - Disk image
2. `SMC.app` - Application bundle
3. License embedded in app bundle

### Linux Distribution
1. `SMC-1.0.0.AppImage` - Portable app
2. Include `license.lic` in same directory

## 🔧 Advanced Configuration

### Custom Build Scripts (HKDF v2.0)
```json
{
  "scripts": {
    "build:custom": "npm run build-prep --license=./cli/custom-license.lic && npm run build:ds16",
    "build:multi": "npm run build:production:ds12 --license=./cli/license.lic && npm run build:production:ds16 --license=./cli/license.lic"
  }
}
```

### Environment-Specific Builds (HKDF)
```bash
# Staging build with staging license
npm run build-prep --license=./cli/staging-license.lic
NODE_ENV=staging npm run build:ds12

# Demo build with demo license (no production data)
npm run build-prep --license=./cli/demo-license.lic
npm run build:ds12
```

## 📞 Support

### Build Issues (HKDF v2.0)
1. Check system requirements (Node.js v18+)
2. Verify license file exists and is valid HKDF v2.0 format
3. Ensure build-prep ran successfully with license
4. Run diagnostic commands: `npm run validate:build-ready`

### License Issues (Enhanced Security)
1. Use SMC License CLI diagnostics: `smc-license validate --file license.lic`
2. Test ESP32 connectivity: `smc-license test-esp32 --ip [ESP32-IP]`
3. Check license expiry: `smc-license info --file license.lic`
4. Verify HKDF key derivation: `smc-license show-key --file license.lic`

### HKDF v2.0 Advantages
- ✅ No shared key management required
- ✅ Enhanced security with per-license encryption  
- ✅ Self-contained license system
- ✅ Hardware binding with MAC address protection

For additional support, refer to:
- `docs/guides/license-deployment.md` - Complete deployment workflow
- `docs/guides/development-workflow.md` - Development setup
- `cli/README.md` - HKDF v2.0 CLI documentation