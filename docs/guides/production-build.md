# SMC App - Production Build Guide

## Overview

คู่มือการ build SMC Application สำหรับ production deployment พร้อมระบบ license validation และการจัดการฐานข้อมูล

## 🚀 Quick Start

```bash
# Build สำหรับ DS12 (12-slot cabinet)
npm run build:production:ds12

# Build สำหรับ DS16 (16-slot cabinet) 
npm run build:production:ds16

# เตรียมการ build เท่านั้น (ไม่ build Electron app)
npm run build-prep:ds12
```

## 📋 Prerequisites

### System Requirements
- **Node.js**: v16.0.0 หรือสูงกว่า
- **npm**: v8.0.0 หรือสูงกว่า
- **Platform**: Windows, macOS, หรือ Linux

### Environment Variables
สร้างไฟล์ `.env` ใน root directory:

```env
# Required for production build
SHARED_SECRET_KEY=SMC_LICENSE_ENCRYPTION_KEY_2024_SECURE_MEDICAL_DEVICE_BINDING_32CHARS
ORGANIZATION_NAME=SMC Medical Center
DEVICE_TYPE=DS12

# Optional development settings
NODE_ENV=production
BYPASS_LICENSE=false
```

### License File Requirements
- **File**: `license.lic` (generated by SMC License CLI)
- **Location**: `resources/license.lic` (ใน project root)
- **Format**: AES-256-CBC encrypted JSON
- **Content**: Organization, Customer ID, MAC address, Expiry date

## 🔧 Build Process

### Step 1: Prepare Build Environment

```bash
# ตรวจสอบความพร้อมของระบบ
npm run validate:build-ready

# เตรียม build environment
npm run build-prep:ds12  # หรือ ds16
```

Build preparation script จะทำ:
1. **Database Reset**: ล้างและสร้างฐานข้อมูลใหม่
2. **Organization Setup**: ตั้งค่าข้อมูลองค์กร
3. **Resources Directory**: เตรียมโฟลเดอร์สำหรับ license
4. **Environment Validation**: ตรวจสอบ dependencies และ configuration

### Step 2: Build Electron Application

```bash
# Complete production build (รวม build-prep)
npm run build:production:ds12

# หรือ build แยกขั้นตอน
npm run build-prep:ds12
npm run build:ds12
```

### Step 3: License Integration

```bash
# Generate license using CLI tool
cd ../cli
smc-license generate -o "SMC Medical Center" -c "CUSTOMER001" -a "SMC_Cabinet" -e "2025-12-31" --wifi-ssid "SMC_WiFi" --wifi-password "SecurePass123!"

# Copy license to resources directory
cp license.lic ../resources/license.lic

# Validate license system
cd ..
npm run validate:license-system
```

## 📁 Build Output

### Directory Structure
```
dist/
├── win-unpacked/           # Windows build
│   ├── SMC.exe             # Main executable
│   ├── resources/
│   │   ├── app.asar        # Application code
│   │   ├── db/
│   │   │   └── database.db # SQLite database
│   │   └── license.lic     # License file (copy manually)
│   └── ...
├── SMC Setup 1.0.0.exe     # Windows installer
└── ...
```

### macOS Build
```
dist/
├── mac/
│   └── SMC.app/
│       └── Contents/
│           ├── MacOS/SMC
│           └── Resources/
│               ├── app.asar
│               ├── db/database.db
│               └── license.lic
└── SMC-1.0.0.dmg           # macOS installer
```

## 🔒 License Deployment

### Production License Workflow

1. **Generate License** (Developer):
   ```bash
   smc-license generate -o "Hospital ABC" -c "HOSP001" -a "SMC_Pro" -e "2025-12-31" --wifi-ssid "HOSP_ESP32" --wifi-password "HospitalSecure123"
   ```

2. **Copy License** (Build Process):
   ```bash
   cp license.lic resources/license.lic
   ```

3. **Build Application**:
   ```bash
   npm run build:production:ds12
   ```

4. **Deploy** (Delivery):
   - Copy `license.lic` ไปด้วยกับ application
   - ติดตั้ง application บน customer site
   - License จะถูก validate อัตโนมัติตอน startup

### License File Locations (Priority Order)
1. `resources/license.lic` (Production)
2. `dist/resources/license.lic` (Build output)
3. `./license.lic` (Current directory)
4. Environment variable: `SMC_LICENSE_FILE_PATH`

## 🛠 Development vs Production

### Development Mode
```bash
# Development build with license bypass
NODE_ENV=development BYPASS_LICENSE=true npm run dev:ds12

# Development build with license validation
NODE_ENV=development npm run dev:ds12
```

### Production Mode
```bash
# Production build (license required)
NODE_ENV=production npm run build:production:ds12
```

## 🧪 Testing & Validation

### Build Validation
```bash
# ตรวจสอบ build configuration
npm run config:validate

# ตรวจสอบ license system
npm run validate:license-system

# ตรวจสอบความพร้อมของ build
npm run validate:build-ready
```

### License Testing
```bash
# ทดสอบ license validation
cd cli
smc-license validate -f ../resources/license.lic

# ทดสอบ ESP32 connection
smc-license test-esp32 --ip 192.168.4.1
```

### End-to-End Testing
```bash
# รัน integration tests
npm run test:integration

# ทดสอบ dispensing workflow
npm run test:dispensing-workflow

# ทดสอบ hardware connection
npm run test:hardware
```

## 🚨 Troubleshooting

### Common Build Issues

**1. Database Creation Failed**
```bash
# Solution: Check permissions and dependencies
sudo npm install sqlite3 --build-from-source
npm run build-prep:ds12
```

**2. License File Not Found**
```bash
# Solution: Verify license file location
ls -la resources/license.lic
export SMC_LICENSE_FILE_PATH=/path/to/license.lic
```

**3. TypeScript Compilation Errors**
```bash
# Solution: Clean and rebuild
npm run clean
npm install
npm run build:production:ds12
```

**4. Electron Build Failed**
```bash
# Solution: Check Node.js version and rebuild native modules
node --version  # Should be >= 16.0.0
npm run postinstall
npm run build:ds12
```

### License Validation Issues

**1. MAC Address Mismatch**
```
Error: MAC address mismatch between license and ESP32
Solution: 
- Generate new license with correct MAC address
- Check ESP32 connection: smc-license test-esp32
```

**2. License Expired**
```
Error: License expired on 2024-12-31
Solution:
- Generate new license with future expiry date
- Use --no-expiry for permanent licenses (if allowed)
```

**3. Database Not Activated**
```
Error: System not activated - no license found in database
Solution:
- Run license activation: Use SMC app activation dialog
- Check database: npm run validate:build-ready
```

## 📦 Distribution

### Windows Distribution
1. `SMC Setup 1.0.0.exe` - Installer
2. `win-unpacked/` - Portable version
3. Include `license.lic` in same directory

### macOS Distribution  
1. `SMC-1.0.0.dmg` - Disk image
2. `SMC.app` - Application bundle
3. License embedded in app bundle

### Linux Distribution
1. `SMC-1.0.0.AppImage` - Portable app
2. Include `license.lic` in same directory

## 🔧 Advanced Configuration

### Custom Build Scripts
```json
{
  "scripts": {
    "build:custom": "cross-env ORGANIZATION_NAME=\"Custom Hospital\" DEVICE_TYPE=DS16 npm run build:production:ds16",
    "build:multi": "npm run build:production:ds12 && npm run build:production:ds16"
  }
}
```

### Environment-Specific Builds
```bash
# Staging build
NODE_ENV=staging npm run build:production:ds12

# Demo build (with license bypass)
BYPASS_LICENSE=true npm run build:production:ds12
```

## 📞 Support

### Build Issues
1. Check system requirements
2. Verify environment variables
3. Validate license file
4. Run diagnostic commands

### License Issues  
1. Use SMC License CLI diagnostics
2. Test ESP32 connectivity
3. Check license expiry date
4. Verify MAC address binding

For additional support, refer to:
- `cli/README.md` - License CLI documentation
- `docs/system-architecture/` - Technical documentation  
- GitHub Issues - Bug reports and feature requests